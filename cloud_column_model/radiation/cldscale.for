c********************************************************************
      subroutine cldscale (m,np,cosz,fcld,taucld,ict,icb,
     *                     cc,tauclb,tauclf)
c********************************************************************
c
c   this subroutine computes the high, middle, and low cloud
c    amounts and scales the cloud optical thickness (section 7)
c
c   to simplify calculations in a cloudy atmosphere, clouds are
c    grouped into high, middle and low clouds separated by the levels
c    ict and icb (level 1 is the top of the model atmosphere).
c
c   within each of the three groups, clouds are assumed maximally
c    overlapped, and the cloud cover (cc) of a group is the maximum
c    cloud cover of all the layers in the group.  the optical thickness
c    (taucld) of a given layer is then scaled to new values (tauclb and
c    tauclf) so that the layer reflectance corresponding to the cloud
c    cover cc is the same as the original reflectance with optical
c    thickness taucld and cloud cover fcld.
c
c---input parameters
c
c    number of atmospheric soundings (m)
c    number of atmospheric layers (np)
c    cosine of the solar zenith angle (cosz)
c    fractional cloud cover (fcld)
c    cloud optical thickness (taucld)
c    index separating high and middle clouds (ict)
c    index separating middle and low clouds (icb)
c
c---output parameters
c
c    fractional cover of high, middle, and low cloud groups (cc)
c    scaled cloud optical thickness for direct  radiation (tauclb)
c    scaled cloud optical thickness for diffuse radiation (tauclf)
c
c********************************************************************
      implicit none
c-----input parameters
      integer m,np,ict,icb
      real cosz(m),fcld(m,np),taucld(m,np,3)
c-----output parameters
      real cc(m,3),tauclb(m,np),tauclf(m,np)
c-----temporary variables
      integer i,j,k,im,it,ia,kk
      real  fm,ft,fa,xai,taux
c-----pre-computed table
c     size of cosz-interval:         dm
c     size of taucld-interval:       dt
c     size of cloud amount-interval: da
      integer   nm,nt,na
      parameter (nm=11,nt=9,na=11) 
      real  dm,dt,da,t1,caib(nm,nt,na),caif(nt,na)
      parameter (dm=0.1,dt=0.30103,da=0.1,t1=-0.9031)
c-----include the pre-computed table of mcai for scaling the cloud optical
c     thickness under the assumption that clouds are maximally overlapped
c
c     caib is for scaling the cloud optical thickness for direct radiation
c     caif is for scaling the cloud optical thickness for diffuse radiation
c     include "mcai.data"
      data ((caib(1,i,j),j=1,11),i=1,9)/
     1 .000,0.068,0.140,0.216,0.298,0.385,0.481,0.586,0.705,0.840,1.000,
     2 .000,0.052,0.106,0.166,0.230,0.302,0.383,0.478,0.595,0.752,1.000,
     3 .000,0.038,0.078,0.120,0.166,0.218,0.276,0.346,0.438,0.582,1.000,
     4 .000,0.030,0.060,0.092,0.126,0.164,0.206,0.255,0.322,0.442,1.000,
     5 .000,0.025,0.051,0.078,0.106,0.136,0.170,0.209,0.266,0.462,1.000,
     6 .000,0.023,0.046,0.070,0.095,0.122,0.150,0.187,0.278,0.577,1.000,
     7 .000,0.022,0.043,0.066,0.089,0.114,0.141,0.187,0.354,0.603,1.000,
     8 .000,0.021,0.042,0.063,0.086,0.108,0.135,0.214,0.349,0.565,1.000,
     9 .000,0.021,0.041,0.062,0.083,0.105,0.134,0.202,0.302,0.479,1.000/
      data ((caib(2,i,j),j=1,11),i=1,9)/
     1 .000,0.088,0.179,0.272,0.367,0.465,0.566,0.669,0.776,0.886,1.000,
     2 .000,0.079,0.161,0.247,0.337,0.431,0.531,0.637,0.749,0.870,1.000,
     3 .000,0.065,0.134,0.207,0.286,0.372,0.466,0.572,0.692,0.831,1.000,
     4 .000,0.049,0.102,0.158,0.221,0.290,0.370,0.465,0.583,0.745,1.000,
     5 .000,0.037,0.076,0.118,0.165,0.217,0.278,0.354,0.459,0.638,1.000,
     6 .000,0.030,0.061,0.094,0.130,0.171,0.221,0.286,0.398,0.631,1.000,
     7 .000,0.026,0.052,0.081,0.111,0.146,0.189,0.259,0.407,0.643,1.000,
     8 .000,0.023,0.047,0.072,0.098,0.129,0.170,0.250,0.387,0.598,1.000,
     9 .000,0.022,0.044,0.066,0.090,0.118,0.156,0.224,0.328,0.508,1.000/
      data ((caib(3,i,j),j=1,11),i=1,9)/
     1 .000,0.094,0.189,0.285,0.383,0.482,0.582,0.685,0.788,0.894,1.000,
     2 .000,0.088,0.178,0.271,0.366,0.465,0.565,0.669,0.776,0.886,1.000,
     3 .000,0.079,0.161,0.247,0.337,0.431,0.531,0.637,0.750,0.870,1.000,
     4 .000,0.066,0.134,0.209,0.289,0.375,0.470,0.577,0.697,0.835,1.000,
     5 .000,0.050,0.104,0.163,0.227,0.300,0.383,0.483,0.606,0.770,1.000,
     6 .000,0.038,0.080,0.125,0.175,0.233,0.302,0.391,0.518,0.710,1.000,
     7 .000,0.031,0.064,0.100,0.141,0.188,0.249,0.336,0.476,0.689,1.000,
     8 .000,0.026,0.054,0.084,0.118,0.158,0.213,0.298,0.433,0.638,1.000,
     9 .000,0.023,0.048,0.074,0.102,0.136,0.182,0.254,0.360,0.542,1.000/
      data ((caib(4,i,j),j=1,11),i=1,9)/
     1 .000,0.096,0.193,0.290,0.389,0.488,0.589,0.690,0.792,0.896,1.000,
     2 .000,0.092,0.186,0.281,0.378,0.477,0.578,0.680,0.785,0.891,1.000,
     3 .000,0.086,0.174,0.264,0.358,0.455,0.556,0.660,0.769,0.882,1.000,
     4 .000,0.074,0.153,0.235,0.323,0.416,0.514,0.622,0.737,0.862,1.000,
     5 .000,0.061,0.126,0.195,0.271,0.355,0.449,0.555,0.678,0.823,1.000,
     6 .000,0.047,0.098,0.153,0.215,0.286,0.370,0.471,0.600,0.770,1.000,
     7 .000,0.037,0.077,0.120,0.170,0.230,0.303,0.401,0.537,0.729,1.000,
     8 .000,0.030,0.062,0.098,0.138,0.187,0.252,0.343,0.476,0.673,1.000,
     9 .000,0.026,0.053,0.082,0.114,0.154,0.207,0.282,0.391,0.574,1.000/
      data ((caib(5,i,j),j=1,11),i=1,9)/
     1 .000,0.097,0.194,0.293,0.392,0.492,0.592,0.693,0.794,0.897,1.000,
     2 .000,0.094,0.190,0.286,0.384,0.483,0.584,0.686,0.789,0.894,1.000,
     3 .000,0.090,0.181,0.274,0.370,0.468,0.569,0.672,0.778,0.887,1.000,
     4 .000,0.081,0.165,0.252,0.343,0.439,0.539,0.645,0.757,0.874,1.000,
     5 .000,0.069,0.142,0.218,0.302,0.392,0.490,0.598,0.717,0.850,1.000,
     6 .000,0.054,0.114,0.178,0.250,0.330,0.422,0.529,0.656,0.810,1.000,
     7 .000,0.042,0.090,0.141,0.200,0.269,0.351,0.455,0.589,0.764,1.000,
     8 .000,0.034,0.070,0.112,0.159,0.217,0.289,0.384,0.515,0.703,1.000,
     9 .000,0.028,0.058,0.090,0.128,0.174,0.231,0.309,0.420,0.602,1.000/
      data ((caib(6,i,j),j=1,11),i=1,9)/
     1 .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000,
     2 .000,0.096,0.193,0.290,0.389,0.488,0.588,0.690,0.792,0.895,1.000,
     3 .000,0.092,0.186,0.281,0.378,0.477,0.577,0.680,0.784,0.891,1.000,
     4 .000,0.086,0.174,0.264,0.358,0.455,0.556,0.661,0.769,0.882,1.000,
     5 .000,0.075,0.154,0.237,0.325,0.419,0.518,0.626,0.741,0.865,1.000,
     6 .000,0.062,0.129,0.201,0.279,0.366,0.462,0.571,0.694,0.836,1.000,
     7 .000,0.049,0.102,0.162,0.229,0.305,0.394,0.501,0.631,0.793,1.000,
     8 .000,0.038,0.080,0.127,0.182,0.245,0.323,0.422,0.550,0.730,1.000,
     9 .000,0.030,0.064,0.100,0.142,0.192,0.254,0.334,0.448,0.627,1.000/
      data ((caib(7,i,j),j=1,11),i=1,9)/
     1 .000,0.098,0.198,0.296,0.396,0.496,0.596,0.696,0.797,0.898,1.000,
     2 .000,0.097,0.194,0.293,0.392,0.491,0.591,0.693,0.794,0.897,1.000,
     3 .000,0.094,0.190,0.286,0.384,0.483,0.583,0.686,0.789,0.894,1.000,
     4 .000,0.089,0.180,0.274,0.369,0.467,0.568,0.672,0.778,0.887,1.000,
     5 .000,0.081,0.165,0.252,0.344,0.440,0.541,0.646,0.758,0.875,1.000,
     6 .000,0.069,0.142,0.221,0.306,0.397,0.496,0.604,0.722,0.854,1.000,
     7 .000,0.056,0.116,0.182,0.256,0.338,0.432,0.540,0.666,0.816,1.000,
     8 .000,0.043,0.090,0.143,0.203,0.273,0.355,0.455,0.583,0.754,1.000,
     9 .000,0.034,0.070,0.111,0.157,0.210,0.276,0.359,0.474,0.650,1.000/
      data ((caib(8,i,j),j=1,11),i=1,9)/
     1 .000,0.099,0.198,0.298,0.398,0.497,0.598,0.698,0.798,0.899,1.000,
     2 .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000,
     3 .000,0.096,0.193,0.290,0.390,0.489,0.589,0.690,0.793,0.896,1.000,
     4 .000,0.093,0.186,0.282,0.379,0.478,0.578,0.681,0.786,0.892,1.000,
     5 .000,0.086,0.175,0.266,0.361,0.458,0.558,0.663,0.771,0.883,1.000,
     6 .000,0.076,0.156,0.240,0.330,0.423,0.523,0.630,0.744,0.867,1.000,
     7 .000,0.063,0.130,0.203,0.282,0.369,0.465,0.572,0.694,0.834,1.000,
     8 .000,0.049,0.102,0.161,0.226,0.299,0.385,0.486,0.611,0.774,1.000,
     9 .000,0.038,0.078,0.122,0.172,0.229,0.297,0.382,0.498,0.672,1.000/
      data ((caib(9,i,j),j=1,11),i=1,9)/
     1 .000,0.099,0.199,0.298,0.398,0.498,0.598,0.699,0.799,0.899,1.000,
     2 .000,0.099,0.198,0.298,0.398,0.497,0.598,0.698,0.798,0.899,1.000,
     3 .000,0.098,0.196,0.295,0.394,0.494,0.594,0.695,0.796,0.898,1.000,
     4 .000,0.096,0.193,0.290,0.389,0.488,0.588,0.690,0.792,0.895,1.000,
     5 .000,0.092,0.185,0.280,0.376,0.474,0.575,0.678,0.782,0.890,1.000,
     6 .000,0.084,0.170,0.259,0.351,0.447,0.547,0.652,0.762,0.878,1.000,
     7 .000,0.071,0.146,0.224,0.308,0.398,0.494,0.601,0.718,0.850,1.000,
     8 .000,0.056,0.114,0.178,0.248,0.325,0.412,0.514,0.638,0.793,1.000,
     9 .000,0.042,0.086,0.134,0.186,0.246,0.318,0.405,0.521,0.691,1.000/
      data ((caib(10,i,j),j=1,11),i=1,9)/
     1 .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000,
     2 .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000,
     3 .000,0.100,0.200,0.300,0.400,0.500,0.600,0.700,0.800,0.900,1.000,
     4 .000,0.100,0.199,0.298,0.398,0.498,0.598,0.698,0.798,0.899,1.000,
     5 .000,0.098,0.196,0.294,0.392,0.491,0.590,0.691,0.793,0.896,1.000,
     6 .000,0.092,0.185,0.278,0.374,0.470,0.570,0.671,0.777,0.886,1.000,
     7 .000,0.081,0.162,0.246,0.333,0.424,0.521,0.625,0.738,0.862,1.000,
     8 .000,0.063,0.128,0.196,0.270,0.349,0.438,0.540,0.661,0.809,1.000,
     9 .000,0.046,0.094,0.146,0.202,0.264,0.337,0.426,0.542,0.710,1.000/
      data ((caib(11,i,j),j=1,11),i=1,9)/
     1 .000,0.101,0.202,0.302,0.402,0.502,0.602,0.702,0.802,0.901,1.000,
     2 .000,0.102,0.202,0.303,0.404,0.504,0.604,0.703,0.802,0.902,1.000,
     3 .000,0.102,0.205,0.306,0.406,0.506,0.606,0.706,0.804,0.902,1.000,
     4 .000,0.104,0.207,0.309,0.410,0.510,0.609,0.707,0.805,0.902,1.000,
     5 .000,0.106,0.208,0.309,0.409,0.508,0.606,0.705,0.803,0.902,1.000,
     6 .000,0.102,0.202,0.298,0.395,0.493,0.590,0.690,0.790,0.894,1.000,
     7 .000,0.091,0.179,0.267,0.357,0.449,0.545,0.647,0.755,0.872,1.000,
     8 .000,0.073,0.142,0.214,0.290,0.372,0.462,0.563,0.681,0.822,1.000,
     9 .000,0.053,0.104,0.158,0.217,0.281,0.356,0.446,0.562,0.726,1.000/
      data ((caif(i,j),j=1,11),i=1,9)/
     1 .000,0.099,0.198,0.297,0.397,0.496,0.597,0.697,0.798,0.899,1.000,
     2 .000,0.098,0.196,0.294,0.394,0.494,0.594,0.694,0.796,0.898,1.000,
     3 .000,0.096,0.192,0.290,0.388,0.487,0.587,0.689,0.792,0.895,1.000,
     4 .000,0.092,0.185,0.280,0.376,0.476,0.576,0.678,0.783,0.890,1.000,
     5 .000,0.085,0.173,0.263,0.357,0.454,0.555,0.659,0.768,0.881,1.000,
     6 .000,0.076,0.154,0.237,0.324,0.418,0.517,0.624,0.738,0.864,1.000,
     7 .000,0.063,0.131,0.203,0.281,0.366,0.461,0.567,0.688,0.830,1.000,
     8 .000,0.052,0.107,0.166,0.232,0.305,0.389,0.488,0.610,0.770,1.000,
     9 .000,0.043,0.088,0.136,0.189,0.248,0.317,0.400,0.510,0.675,1.000/
c-----clouds within each of the high, middle, and low clouds are assumed
c     to be maximally overlapped, and the cloud cover (cc) for a group
c     (high, middle, or low) is the maximum cloud cover of all the layers
c     within a group
      do i=1,m
         cc(i,1)=0.0
         cc(i,2)=0.0
         cc(i,3)=0.0
      enddo
      do k=1,ict-1
       do i=1,m
          cc(i,1)=max(cc(i,1),fcld(i,k))
       enddo
      enddo
      do k=ict,icb-1
       do i=1,m
          cc(i,2)=max(cc(i,2),fcld(i,k))
       enddo
      enddo
      do k=icb,np
       do i=1,m
          cc(i,3)=max(cc(i,3),fcld(i,k))
       enddo
      enddo
c-----scale the cloud optical thickness.
c     taucld(i,k,1) is the optical thickness for ice particles
c     taucld(i,k,2) is the optical thickness for liquid particles
c     taucld(i,k,3) is the optical thickness for rain drops
      do k=1,np
         if(k.lt.ict) then
            kk=1
         elseif(k.ge.ict .and. k.lt.icb) then
            kk=2
         else
            kk=3
         endif
       do i=1,m
         tauclb(i,k) = 0.0
         tauclf(i,k) = 0.0
         taux=taucld(i,k,1)+taucld(i,k,2)+taucld(i,k,3)
         if (taux.gt.0.02 .and. fcld(i,k).gt.0.01) then
c-----normalize cloud cover following eq. (7.8)
           fa=fcld(i,k)/cc(i,kk)
c-----table look-up
           taux=min(taux,32.)
           fm=cosz(i)/dm
           ft=(log10(taux)-t1)/dt
           fa=fa/da
           im=int(fm+1.5)
           it=int(ft+1.5)
           ia=int(fa+1.5)
           im=max(im,2)
           it=max(it,2)
           ia=max(ia,2)
           im=min(im,nm-1)
           it=min(it,nt-1)
           ia=min(ia,na-1)
           fm=fm-float(im-1)
           ft=ft-float(it-1)
           fa=fa-float(ia-1)
c-----scale cloud optical thickness for beam radiation following eq. (7.3)
c     the scaling factor, xai, is a function of the solar zenith
c     angle, optical thickness, and cloud cover.
           xai=    (-caib(im-1,it,ia)*(1.-fm)+
     *      caib(im+1,it,ia)*(1.+fm))*fm*.5+caib(im,it,ia)*(1.-fm*fm)
           xai=xai+(-caib(im,it-1,ia)*(1.-ft)+
     *      caib(im,it+1,ia)*(1.+ft))*ft*.5+caib(im,it,ia)*(1.-ft*ft)
           xai=xai+(-caib(im,it,ia-1)*(1.-fa)+
     *     caib(im,it,ia+1)*(1.+fa))*fa*.5+caib(im,it,ia)*(1.-fa*fa)
           xai= xai-2.*caib(im,it,ia)
           xai=max(xai,0.0)
           xai=min(xai,1.0)
           tauclb(i,k) = taux*xai
c-----scale cloud optical thickness for diffuse radiation following eq. (7.4)
c     the scaling factor, xai, is a function of the cloud optical
c     thickness and cover but not the solar zenith angle.
           xai=    (-caif(it-1,ia)*(1.-ft)+
     *      caif(it+1,ia)*(1.+ft))*ft*.5+caif(it,ia)*(1.-ft*ft)
           xai=xai+(-caif(it,ia-1)*(1.-fa)+
     *      caif(it,ia+1)*(1.+fa))*fa*.5+caif(it,ia)*(1.-fa*fa)
           xai= xai-caif(it,ia)
           xai=max(xai,0.0)
           xai=min(xai,1.0)
           tauclf(i,k) = taux*xai
         endif
       enddo
      enddo
      return
      end
